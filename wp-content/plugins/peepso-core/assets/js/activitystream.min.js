!function(t,e,o){var i,s,a,n,r,d,l,p=(i="PsActivityStream",s=e,peepso.observer,a="scroll.ps-activity-stream",n=+peepsodata.currentuserid,r=+peepsodata.userid,d=s("#peepso_post_id").val()||void 0,l=s("#peepso_context").val()||void 0,peepso.createClass(i,{__constructor:function(t,e){this.$el=s(t),this.$recent=s("#ps-activitystream-recent"),this.$loading=s("#ps-activitystream-loading"),this.$noPosts=s("#ps-no-posts"),this.$noPostsMatch=s("#ps-no-posts-match"),this.$noMorePosts=s("#ps-no-more-posts"),this.$filters=s(".ps-js-activitystream-filter"),this.loading=!1,this.loadEnd=!1,this.loadPage=1,this.loadLimit=+peepsodata.activity_limit_below_fold,this.loadButtonEnabled=+peepsodata.loadmore_enable,this.loadButtonRepeat=this.loadButtonEnabled?+peepsodata.loadmore_repeat:0,this.loadButtonTemplate=e.template_load_more,this.isPermalink=+e.is_permalink,this.hideFromGuest=+e.hide_from_guest,this.loadLimit=this.loadLimit>0?this.loadLimit:3,this.streamData={},s("[id^=peepso_stream_]").each(s.proxy(function(t,e){var o=e.id.replace(/^peepso_/,""),i=e.value;this.streamData[o]=i},this)),s(document).on("peepso_login_shown",function(){this.$loading.hide()}),this.$filters.on("click",".ps-js-dropdown-toggle",s.proxy(this.onFilterToggle,this)),this.$filters.on("click","[data-option-value]",s.proxy(this.onFilterSelect,this)),this.$filters.on("click",".ps-js-cancel",s.proxy(this.onFilterCancel,this)),this.$filters.on("click",".ps-js-apply",s.proxy(this.onFilterApply,this)),this.$filters.on("click","[type=text]",s.proxy(this.onFilterFocus,this)),this.$filters.on("keyup","[type=text]",s.proxy(this.onFilterKeyup,this)),this.$filters.on("click",".ps-js-search",s.proxy(this.onFilterSearch,this));var o=s("#ps-activitystream-search");this.search(o.eq(0).val()),peepso.observer.addAction("peepso_stream_reset",s.proxy(function(){this.search(o.eq(0).val())},this))},search:function(t){var e,o;t=s.trim(t||""),this.searchKeyword=t,this.searchMode="exact",this.reset(),(e=s(".ps-js-activitystream-filter").filter("[data-id=peepso_search]").find(".ps-js-dropdown-toggle").find("span")).length&&(t?(o=e.data("keyword"),o+=t+'<i class="ps-icon-remove"></i>',e.one("click","i",s.proxy(function(t){s("#ps-activitystream-search").val(""),this.search("")},this))):o=e.data("empty"),e.html(o))},autoload:function(t){if(t===this._token&&!this.loading)return!n&&this.hideFromGuest?(this.$loading.hide(),!1):void(this.shouldLoad()?(this.loading=!0,this.load(t).done(s.proxy(function(){this.loading=!1,this.isPermalink||this.loadEnd||this.autoload(t)},this))):this.loadButtonEnabled&&!this.$loadButton?(this.$loadButton=s(this.loadButtonTemplate).insertAfter(this.$el),this.$loadButton.one("click",s.proxy(function(e){s(e.currentTarget).remove(),this.autoload(t)},this))):this._onScrollEnabled||(this._onScrollEnabled=!0,s(window).on(a,t,s.proxy(this.onScroll,this))))},shouldLoad:function(){var t,e,o,i=this.$el.children(".ps-js-activity");return!this.loadEnd&&(!i.length||(this.loadButtonEnabled&&this.loadButtonRepeat?i.length%this.loadButtonRepeat!=0||!!this.$loadButton&&(delete this.$loadButton,!0):!!(t=i.slice(0-this.loadLimit).eq(0)).length&&(e=this.loadButtonEnabled&&!this.$loadButton?t.eq(0).offset():t[0].getBoundingClientRect(),o=window.innerHeight||document.documentElement.clientHeight,e.top<o)))},load:function(t){var e,o=this,i=peepso.disableAuth().disableError();return e=_.extend({uid:n,user_id:r,post_id:d,context:l,page:this.loadPage,search:this.searchKeyword||void 0,search_mode:this.searchKeyword&&this.searchMode||void 0,pinned:1===this.loadPage?1:void 0},this.streamData||{}),e=peepso.observer.applyFilters("show_more_posts",e),s.Deferred(function(s){o.$loading.show(),i.postJson("activity.show_posts_per_page",e,function(i){t===o._token&&(o.$loading.hide(),i.data.found_posts>0?(o.render(i.data.posts),o.loadPage++):o.loadEnd=!0,o.loadEnd&&(e.page>1?o.$noMorePosts.show():o.searchKeyword?o.$noPostsMatch.show():o.$noPosts.show()),s.resolve())})})},reset:function(){this.loading=!1,this.loadEnd=!1,this.loadPage=1,this._onScrollEnabled=!1,s(window).off(a),this.$loadButton&&(this.$loadButton.remove(),this.$loadButton=void 0),this.$el.empty().hide(),this.$recent.empty(),this.$noMorePosts.hide(),this.$noPosts.hide(),this.$noPostsMatch.hide(),this._token=(new Date).getTime(),this.autoload(this._token)},render:function(t){var e,o=s(t),i=this.searchKeyword,a=this.searchMode;o.find(".ps-js-activity-content, .ps-comment-item, .ps-stream-quote").each(function(){var t=s(this),e=t.html();e=peepso.observer.applyFilters("peepso_activity_content",e),t.html(e)}),i&&(e='<span class="ps-text--highlight">$1</span>',o.find(".ps-js-activity-content").each(function(){var t=s(this),o=t.html(),n=[i];"any"===a&&(n=_.filter(i.split(" "),function(t){return t})),n=_.map(n,function(t){return t.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&")}),n=RegExp("("+n.join("|")+")(?![^<>]+>)","ig"),o=o.replace(n,e),t.html(o)})),this.$el.is(":hidden")&&this.$el.show();try{o.appendTo(this.$el)}catch(t){}o.hide().fadeIn(1e3,function(){s(document).trigger("ps_activitystream_loaded")}),s("textarea[name=comment]",o).ps_autosize()},onScroll:_.throttle(function(t){var e=t.data;this.autoload(e)},1),onFilterToggle:_.debounce(function(t){var e,o=s(t.currentTarget),i=o.closest(".ps-js-activitystream-filter"),a=i.data("id").replace(/^peepso_/,""),n=this.streamData[a];i.is(":visible")&&(e=i.find("[type=radio]").filter('[value="'+n+'"]')).length&&(e[0].checked=!0)},1),onFilterSelect:function(t){var e=s(t.currentTarget),o=e.find("[type=radio]");t.preventDefault(),t.stopPropagation(),_.defer(function(){o[0].checked=!0})},onFilterCancel:function(t){var e=s(t.currentTarget);$dropdown=e.closest(".ps-js-activitystream-filter"),$toggle=$dropdown.find(".ps-js-dropdown-toggle"),$toggle.focus()},onFilterApply:function(t){var e=s(t.currentTarget);$dropdown=e.closest(".ps-js-activitystream-filter"),$toggle=$dropdown.find(".ps-js-dropdown-toggle"),$hidden=s("#"+$dropdown.data("id")),$option=$dropdown.find("[type=radio]:checked").closest("[data-option-value]"),value=$option.data("optionValue"),data=$dropdown.data("id").replace(/^peepso_/,""),$hidden.val(value),this.streamData[data]=value,$toggle.find("span").text($option.find("span").text()),$toggle.find('[class*="ps-icon-"]').attr("class",$option.find('[class*="ps-icon-"]').attr("class")),$toggle.focus(),this.reset()},onFilterFocus:function(t){t.stopPropagation()},onFilterKeyup:function(t){t.stopPropagation(),13===t.which&&s(t.currentTarget).closest(".ps-js-activitystream-filter").find(".ps-js-search").click()},onFilterSearch:function(t){var e=s(t.currentTarget);$dropdown=e.closest(".ps-js-activitystream-filter"),$toggle=$dropdown.find(".ps-js-dropdown-toggle"),$hidden=s("#"+$dropdown.data("id")),$option=$dropdown.find("[type=radio]:checked").closest("[data-option-value]"),$input=$dropdown.find("[type=text]"),value=$option.data("optionValue"),data=$dropdown.data("id").replace(/^peepso_/,""),keyword=$input.val().trim(),label=$toggle.find("span").data(keyword?"keyword":"empty"),$hidden.val(value),this.searchKeyword=keyword,this.searchMode=value,keyword?(label=$toggle.find("span").data("keyword"),label=label+keyword+'<i class="ps-icon-remove"></i>'):label=$toggle.find("span").data("empty"),$toggle.find("span").html(label).off("click","i").one("click","i",s.proxy(function(t){var e=s(t.target).closest(".ps-js-dropdown-toggle"),o=e.closest(".ps-js-activitystream-filter"),i=o.find("[type=text]"),a=s("#"+o.data("id"));t.stopPropagation(),i.val(""),a.val(""),e.find("span").html(e.find("span").data("empty")),this.searchKeyword="",this.searchMode="",this.reset()},this)),$toggle.focus(),this.reset()}}));jQuery(function(t){var e,o=t("#ps-activitystream");o.length&&(e=peepsodata&&peepsodata.activity||{},new p(o[0],e))})}(window,jQuery);