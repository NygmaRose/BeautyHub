!function(t,i){peepso=peepso||{},peepso.notification=new(function(t){function i(){var i=this;function o(){setTimeout(function(){i.start()},3e3)}t(function(){_.defer(function(){var i=t("#peepso-wrap").length,e=t("#wpadminbar").find(".psnotification-toggle").length;(i||e)&&o()})}),ps_observer.add_action("notification_start",o)}return i.prototype={_get_latest_interval:+peepsodata.get_latest_interval||3e4,_get_latest_count:function(){peepso.disableAuth().disableError().postJson("notificationsajax.get_latest_count",null,t.proxy(function(i){var o;i.success&&!i.session_timeout&&(o=0,t.each(i.data,function(i,e){var s,n,a=t("."+i),r=Math.max(0,e.count);o+=r,a.length&&(s=+(n=a.find(".ps-js-counter")).eq(0).text(),n.length&&s!==r&&(n.html(r).css("display",r>0?"":"none"),r>0&&a.data("plugin_psnotification")&&a.psnotification("clear_cache")))}),this._update_titlebar(o),ps_observer.do_action("notification_update",i))},this))},_update_titlebar:function(t){var i=(document.title||"").replace(/^\(\d+\)\s*/,"");t>0&&(i="("+t+") "+i),document.title!==i&&(document.title=i)},hide:function(i){var o,e,s;void 0!==i&&((e=this.hide)[s="_progress_"+i]||(e[s]=!0,(o=t(".ps-js-notifications").find(".ps-js-notification--"+i).map(function(){return t(this).parent(".ps-notification__wrapper").get(0)})).css("opacity",.5),peepso.postJson("notificationsajax.hide",{note_id:i},t.proxy(function(t){delete e[s],t.success?(o.remove(),ps_observer.do_action("notification_restart")):o.css("opacity","")},this))))},markAsRead:function(i){return t.Deferred(t.proxy(function(o){var e=null;i&&(e={note_id:i}),peepso.postJson("notificationsajax.mark_as_read",e,t.proxy(function(t){t.success?o.resolveWith(this):t.errors&&o.rejectWith(this,[t.errors[0]])},this))},this))},markAllAsRead:function(){return this.markAsRead()},start:function(){!this._started&&+peepsodata.currentuserid&&(this._started=!0,this._get_latest_count(),this._get_latest_timer=setInterval(t.proxy(this._get_latest_count,this),this._get_latest_interval),t(window).on("peepso_auth_required",t.proxy(function(){clearInterval(this._get_latest_timer)},this)),ps_observer.add_filter("pschat_mark_as_read",this.restart,10,1,this),ps_observer.add_action("notification_restart",this.restart,10,1,this))},restart:function(){+peepsodata.currentuserid&&(clearInterval(this._get_latest_timer),this._get_latest_count(),this._get_latest_timer=setInterval(t.proxy(this._get_latest_count,this),this._get_latest_interval))}},i}(t))}(jQuery),function(t){t.fn.psnotification=function(i){return this.each(function(){if(t.data(this,"plugin_psnotification")){var o=t.data(this,"plugin_psnotification");if(_.isFunction(o[i]))return o[i].call(o)}else t.data(this,"plugin_psnotification",new function(i,o){var e=this;return this.popover=null,this.popover_list=null,this.popover_footer=null,this.popover_header=null,this._notifications={},this.init=function(o){_opts={view_all_text:peepsodata.view_all_text,view_all_link:null,source:null,request:{per_page:10,page:1},header:null,paging:!1,fetch:null},this.opts=ps_observer.apply_filters("peepso_notification_plugin_options",_opts),this._content_is_fetched=!1,t.extend(!0,this.opts,o),t(i).addClass("psnotification-toggle"),this.popover=t("<div>"),this.popover_list=t("<div>").css({maxHeight:"40vh",overflow:"auto"}),this.popover_list.bind("mousewheel",t.proxy(function(i,o){var e=t(i.currentTarget);o>0&&0===e.scrollTop()?i.preventDefault():o<0&&e.scrollTop()==e.get(0).scrollHeight-e.innerHeight()&&i.preventDefault()},this)),t(i).append(this.popover),!1===_.isNull(this.opts.header)&&(this.popover_header=t("<div/>"),this.popover_header.addClass("ps-popover-header app-box-header").append(this.opts.header).append("<div class='ps-clearfix' />"),this.popover.append(this.popover_header)),this.popover.append(this.popover_list),this.popover_list.addClass("ps-notifications ps-notifications--empty"),this.popover.addClass("ps-popover app-box").hide(),this.opts.paging&&this.init_pagination();var s,n=this.opts.view_all_link,a=this.opts.view_all_text;n&&(a=_.isArray(a)?a:[a],n=_.isArray(n)?n:[n],s=[!1,!1,"50%","33%","25%"][n.length],n=_.map(n,function(t,i){return['<a href="',t,'"',s?' style="float:left; width:'+s+'"':"",">",a[i],"</a>"].join("")}),this.popover_footer=t('<div class="ps-popover-footer app-box-footer ps-clearfix"></div>'),this.popover_footer.append(n.join("")),this.popover_footer.appendTo(this.popover)),this.popover_list.on("mousedown.ps-notification",".ps-js-notification a",t.proxy(function(i){var o=t(i.currentTarget),e=o.closest(".ps-js-notification");+e.data("unread")&&(3===i.which||i.ctrlKey||i.altKey||(2===i.which||i.metaKey||i.shiftKey||o.on("click",function(t){t.preventDefault(),t.stopPropagation()}),e.css("opacity",.5),e.removeClass("ps-notification--unread"),peepso.notification.markAsRead(e.data("id")).done(t.proxy(function(){var s=+e.closest(".ps-js-notifications").find(".ps-js-counter").text();e.css("opacity",""),e.data("unread",0),1!==i.which||i.metaKey||i.shiftKey||(o.off("click"),o[0].click()),t(".ps-js-notifications").find(".ps-js-counter").html(s-1).css("display",s>1?"":"none")},this)).fail(function(t){e.addClass("ps-notification--unread"),t&&psmessage.show("",t)})))},this)),this.popover_list.on("mousedown click",".ps-js-mark-as-read",t.proxy(function(i){var o,e;i.preventDefault(),i.stopPropagation(),"click"===i.type&&(o=t(i.currentTarget),e=o.closest(".ps-js-notification"),o.hide(),e.css("opacity",.5),e.removeClass("ps-notification--unread"),peepso.notification.markAsRead(e.data("id")).done(t.proxy(function(){var i=+e.closest(".ps-js-notifications").find(".ps-js-counter").text();o.remove(),e.css("opacity",""),e.data("unread",0),t(".ps-js-notifications").find(".ps-js-counter").html(i-1).css("display",i>1?"":"none")},this)).fail(function(t){e.addClass("ps-notification--unread"),o.show(),t&&psmessage.show("",t)}))},this)),this.popover_footer.on("click",".ps-js-mark-all-as-read",t.proxy(function(i){var o,e=this.popover_list.find(".ps-js-notification");e=e.filter(".ps-notification--unread"),o=e.find(".ps-js-mark-as-read"),confirm(peepsodata.mark_all_as_read_confirm_text)&&(o.hide(),e.css("opacity",.5),e.removeClass("ps-notification--unread"),peepso.notification.markAllAsRead().done(function(){o.remove(),e.css("opacity",""),e.data("unread",0),t(".ps-js-notifications").find(".ps-js-counter").html(0).css("display","none")}).fail(function(t){e.addClass("ps-notification--unread"),o.show(),t&&psmessage.show("",t)}))},this)),this.popover_footer.on("click",".ps-js-toggle-unread-only",t.proxy(function(i){var o=t(i.currentTarget);this._unreadOnly=!this._unreadOnly,o.html(this._unreadOnly?peepsodata.show_all_text:peepsodata.show_unread_only_text),this.popover_list.find(".ps-notification__wrapper").remove(),this.opts.request.page=1,this._content_is_fetched=!1,this.load_page(function(){e.opts.paging&&e.popover_list.trigger("scroll")})},this))},this.fetch=function(t){var i=this.opts.request,o=(this.opts.method||"").toLowerCase();_.isFunction(this.opts.fetch)&&!1===(i=this.opts.fetch.call(this,i))||(this._notifications={},this.fetch_stop(),this.fetch_xhr=$PeepSo["get"===o?"getJson":"postJson"](this.opts.source,i,function(i){i.success?(e._content_is_fetched=!0,e._data=i.data,e._notifications=i.data.notifications,e._errors=!1,e._notifications.length>0&&e.opts.request.page++):i.errors&&(e._content_is_fetched=!0,e._errors=i.errors),"function"==typeof t&&t()}))},this.fetch_stop=function(){this.fetch_xhr&&(this.fetch_xhr.abort?this.fetch_xhr.abort():this.fetch_xhr.ret&&this.fetch_xhr.ret.abort&&this.fetch_xhr.ret.abort())},this.refresh=function(){this.popover_list.find(".ps-notification__wrapper").remove(),this._content_is_fetched=!1,this.load_page(function(){e.opts.paging&&e.popover_list.trigger("scroll")})},this.onClick=function(i){if(!(_.isFunction(e.opts.before_click)&&!1===e.opts.before_click()||e.popover.has(t(i.target)).length>0)){i.preventDefault();var o=e.opts.lazy,s=e.popover.is(":visible");e.show(),!o&&!s&&e.load_page(function(){e.opts.paging&&e.popover_list.trigger("scroll")})}},this.render=function(){t.each(this._notifications,function(i,o){var s=t("<div class='ps-notification__wrapper'></div>");s.html(o).hide(),s.appendTo(e.popover_list).fadeIn("slow")}),t(i).trigger("notifications.shown",[t.extend(i,this)]),t(document.body).hasClass("wp-admin")&&t(i).find("a").attr("target","_blank"),this.popover_list.toggleClass("ps-notifications--empty",0===this.popover_list.find(".ps-notification__wrapper").length)},this.show=function(){this.popover.slideToggle({duration:"fast",start:function(){e.popover.position({my:"right top",at:"bottom",of:t("i",i),using:function(i,o){"right"===o.horizontal?(t(this).removeClass("flipped"),i.left+=40):(t(this).addClass("flipped"),i.left-=40),i.top+=10,t(this).css(i)}})},done:function(){t(document).on("mouseup.notification_click",function(o){t(i).is(o.target)||0!==t(i).has(o.target).length||(e.popover.hide(),t(document).off("mouseup.notification_click"))})}})},this.init_pagination=function(){this.popover_list.on("scroll",function(){e._content_is_fetched&&t(this).scrollTop()+t(this).innerHeight()>=t(this)[0].scrollHeight&&(e._content_is_fetched=!1,e.load_page(function(){e._notifications&&_.isEmpty(e._notifications)?e.popover_list.off("scroll"):e.popover_list.trigger("scroll")}))})},this.load_page=function(i){if(!1===this._content_is_fetched){var o=this.popover_list.nextAll(".ps-popover-error"),s=this.popover_list.nextAll(".ps-popover-loading");o.length&&o.remove(),s.length||(s=t("<div class='ps-popover-loading'><img src='"+peepsodata.loading_gif+"'/></div>"),this.popover_list.after(s)),this.fetch_stop(),setTimeout(function(){e.fetch(function(){s.remove(),e._errors&&(o=t("<div class=ps-popover-error />"),t.each(e._errors,function(i,e){t("<div />").html(e).appendTo(o)}),e.popover_list.after(o)),e.render(),typeof i==typeof Function&&i(),"function"==typeof e.opts.after_load&&e.opts.after_load.apply(e)})},500)}},this.clear_cache=function(){this.popover_list.find(".ps-notification__wrapper").remove(),this.popover.hide(),this.opts.request.page=1,this._content_is_fetched=!1},this.init(o),t(i).on("click",this.onClick),this}(this,i))})},ps_observer.add_action("notification_clear_cache",function(i){t("."+(i=i||"ps-js-notifications")).psnotification("clear_cache")},10,1)}(jQuery),jQuery(function(t){});